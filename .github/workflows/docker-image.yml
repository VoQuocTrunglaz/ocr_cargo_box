name: OCR API CI/CD

on:
  push:
    branches:
      - main  # Cháº¡y khi push lÃªn nhÃ¡nh main

jobs:
  pre_build:
    name: ğŸ“Œ Chuáº©n bá»‹ mÃ´i trÆ°á»ng
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Láº¥y code tá»« GitHub
        uses: actions/checkout@v4

      - name: ğŸ”§ Thiáº¿t láº­p mÃ´i trÆ°á»ng Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: ğŸ“¦ CÃ i Ä‘áº·t dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: âœ… Cháº¡y kiá»ƒm thá»­
        run: |
          PYTHONPATH=$(pwd) pytest --cov=main test/

  build:
    name: ğŸ—ï¸ Build & Push Docker Image lÃªn GHCR
    needs: pre_build  # Chá»‰ cháº¡y khi pre_build thÃ nh cÃ´ng
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Láº¥y code tá»« GitHub
        uses: actions/checkout@v4

      - name: ğŸ”  Chuyá»ƒn Ä‘á»•i tÃªn repository thÃ nh chá»¯ thÆ°á»ng
        run: echo "REPO_NAME=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: ğŸ”‘ ÄÄƒng nháº­p GHCR
        run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: ğŸ—ï¸ Build Docker Image
        run: |
          docker build -t ghcr.io/${{ env.REPO_NAME }}/ocr_cargo_box_api:latest .

      - name: ğŸ“¤ Push Docker Image lÃªn GHCR
        run: |
          docker push ghcr.io/${{ env.REPO_NAME }}/ocr_cargo_box_api:latest

  deploy:
    name: ğŸš€ Triá»ƒn khai lÃªn EC2
    needs: build  # Chá»‰ cháº¡y sau khi build thÃ nh cÃ´ng
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”‘ Thiáº¿t láº­p SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_KEY }}" > ~/.ssh/aws_key.pem
          chmod 600 ~/.ssh/aws_key.pem
          ssh-keyscan -H ${{ secrets.AWS_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ› ï¸ CÃ i Ä‘áº·t Docker trÃªn EC2
        run: |
          ssh -i ~/.ssh/aws_key.pem ubuntu@${{ secrets.AWS_HOST }} << 'EOF'
            sudo apt update && sudo apt upgrade -y
            sudo apt install -y docker.io
            sudo systemctl enable docker
            sudo systemctl start docker
            sudo usermod -aG docker ubuntu
            newgrp docker
            echo "âœ… Docker Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t thÃ nh cÃ´ng!"
          EOF

      - name: ğŸš€ Deploy Docker Container trÃªn EC2
        run: |
          ssh -i ~/.ssh/aws_key.pem ubuntu@${{ secrets.AWS_HOST }} << 'EOF'
            echo "ğŸš€ ÄÄƒng nháº­p vÃ o GHCR"
            echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            echo "ğŸ“¥ Pull image má»›i nháº¥t tá»« GHCR"
            docker pull ghcr.io/${{ env.REPO_NAME }}/ocr_cargo_box_api:latest
            
            echo "ğŸ›‘ Dá»«ng & xÃ³a container cÅ© náº¿u cÃ³"
            docker stop ocr_api || true
            docker rm ocr_api || true
            
            echo "ğŸš€ Cháº¡y container má»›i"
            docker run -d --restart=always -p 80:8000 --name ocr_api ghcr.io/${{ env.REPO_NAME }}/ocr_cargo_box_api:latest
            
            echo "âœ… Kiá»ƒm tra container Ä‘ang cháº¡y"
            docker ps
          EOF